<html>
 <head>
  <title>Breakout!</title>
 </head>
 <body>
   <canvas id="canvas1" width=600 height=600 style="border-style: solid;">
   </canvas>
   <script>
window.onload = setInterval("mainloop()", 1);

var canvas = document.getElementById("canvas1");
var ctx = canvas.getContext('2d');

var total_brick_number = 169;
var paddle = { color: getColor(), width: 80, height: 20, x: (canvas.width / 2), 
               y: (canvas.height - 100), speed: 1, type: 'paddle' };
var ball = { color: getColor(), width: 15, height: 15, x: (canvas.width / 2), 
             y: (canvas.height - 120), speed: 5, moving: false, 
             hitPaddle: false,
             direction_horizontal: "right", direction_vertical: "up" };

ball.collided = function(collidable) {
  left1 = ball.x;
  left2 = collidable.x;
  right1 = ball.x + ball.width;
  right2 = collidable.x + collidable.width;
  top1 = ball.y;
  top2 = collidable.y;
  bottom1 = ball.y + ball.height;
  bottom2 = collidable.y + collidable.height;

  if (bottom1 < top2) return false;
  if (top1 > bottom2) return false;
  if (right1 < left2) return false;
  if (left1 > right2) return false;

  return true;
}

var bricks = new Array();
y = 0;
x = 0;
for (var i=0; i< total_brick_number; i++) {
  color = getColor();
  if (x > canvas.width) {
    y += 20;
    x = 0;
  } 
  brick = { color: color, width: 50, height: 20, x: x, y: y,
            id: i, type: "brick" };
  bricks.push(brick); 
  x += 50;
}

drawBricks();
function mainloop() {
  drawRect(paddle);
  if (ball.moving == true) {
    moveBall();
  } else {
    ctx.clearRect(ball.x, ball.y, ball.width, ball.height);
    ball.x = paddle.x + paddle.width / 2;
  }
  drawRect(ball);
  collidables = bricks.concat();
  collidables.push(paddle);
  for (var i=0; i < collidables.length; i++) {
    collidable = collidables[i];
    if (ball.collided(collidable)) {
      if (collidable.type == 'brick') {
        brick = collidable;
        ctx.clearRect(brick.x, brick.y, brick.width, brick.height);
        for (var j=0; j < bricks.length; j++) {
          if (brick.id == bricks[j].id) {
            bricks.splice(j, 1);
          }
        }
        ball.hitPaddle = false;
      } else if (collidable.type == 'paddle') {
        if (ball.hitPaddle) {
          return;
        } else {
          ball.hitPaddle = true;
        }
      } else {
        ball.hitPaddle = false;
      }
      if (ball.direction_vertical == 'up') {
        ball.direction_vertical = 'down';
      } else if (ball.direction_vertical == 'down') {
        ball.direction_vertical = 'up';
      }
      if (ball.direction_vertical == 'right') {
        ball.direction_vertical = 'left';
      } else if (ball.direction_vertical == 'left') {
        ball.direction_vertical = 'right';
      }
    }
  }
}

function moveBall() {
  ctx.clearRect(ball.x, ball.y, ball.width, ball.height);
  if (ball.direction_horizontal == 'left') {
    if (ball.x > 0) {
      ball.x -= ball.speed;
    } else {
      ball.direction_horizontal = 'right';
      ball.hitPaddle = false;
    }
  }
  if (ball.direction_horizontal == 'right') {
    if ((ball.x + ball.width) < canvas.width) {
      ball.x += ball.speed;
    } else {
      ball.direction_horizontal = 'left';
      ball.hitPaddle = false;
    }
  }
  if (ball.direction_vertical == 'up') {
    if (ball.y > 0) {
      ball.y -= ball.speed;
    } else {
      ball.direction_vertical = 'down';
      ball.hitPaddle = false;
    }
  }
  if (ball.direction_vertical == 'down') {
    if ((ball.y + ball.height) < canvas.height) {
      ball.y += ball.speed;
    } else {
      ball.hitPaddle = false;
      ball.moving = false;
      ball.x = (canvas.width / 2);
      ball.y = (canvas.height - 120);
      ball.direction_vertical = 'up';
    }
  }
}

function movePaddle(direction) {
  ctx.clearRect(paddle.x, paddle.y, paddle.width, paddle.height);
  if (direction == 'left') {
    if (paddle.x > 0) {
      paddle.x -= paddle.speed;
    }
  }
  if (direction == 'right') {
    if ((paddle.x + paddle.width) < canvas.width) {
      paddle.x += paddle.speed;
    }
  }
}

function drawRect(obj) {
  ctx.fillStyle = obj.color;
  ctx.fillRect(obj.x, obj.y, obj.width, obj.height);
}

function drawBricks() {
  for (var i=0; i < bricks.length; i++) {
    brick = bricks[i];
    drawRect(brick);
  }
}

function mouseMove(evt) {
  ctx.clearRect(paddle.x, paddle.y, paddle.width, paddle.height);
  paddle.x = evt.clientX - paddle.width / 2;
  drawRect(paddle);
}

function onClick(evt) {
  ball.moving = true;
}

function getColor() {
  var rgb = [];
  for (var i=0; i<3; i++) {
    rgb[i] = Math.round(100 * Math.random() + 25); 
  }
  return 'rgb(' + rgb.join(',') + ')';
}

window.addEventListener('mousemove', mouseMove, true);
window.addEventListener('click', onClick, true);
   </script>
 </body>
</html>
